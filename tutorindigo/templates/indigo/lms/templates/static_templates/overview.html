<%! from django.utils.translation import ugettext as _ %>

  <%inherit file="../main.html" />
  <%block name="pagetitle">${_("Kursübersicht")}</%block>
  <script type="text/javascript">
    (function (require) {
      require(['course_search/js/dashboard_search_factory'], function (DashboardSearchFactory) {
        DashboardSearchFactory();
      });
    }).call(this, require || RequireJS.require);
  </script>
  <main>
    <div style="position: absolute; left: 0; width: 100vw; height: 500px; background:rgb(163, 156, 156); z-index: 1;"></div>
    <div style="padding-top: 75px; z-index: 2; position: relative; margin-left: 17%;">
        <div style="text-align: start; margin-bottom: 20px; color: rgb(255, 255, 255)!important; font-size: 3em; font-weight: 600; line-height: 1;">ChancenFinder <br>E-Learning Plattform</div>
        <div style="color: rgb(255, 255, 255)!important; max-width: 400px;">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Accusamus esse omnis explicabo perspiciatis alias doloribus placeat odit. Reprehenderit, itaque eum. Repudiandae eum dolores architecto esse eveniet reiciendis eligendi explicabo obcaecati.</div>
        <div style="margin-top: 20px;"><button>Zu den Kursen ></button></div>
    </div>
    <div class="container">
        <!-- Left welcome section -->
        <div class="welcome">
            <h1 class="welcome-title">Willkommen im Chancenfinder</h1>
            <p class="welcome-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco.</p>
            <p class="welcome-text">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco. Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco.</p>
            <a href="#" class="btn">Weiter zur Kursübersicht <i>›</i></a>
        </div>
        
        <!-- Right video section -->
        <div class="video-section" style="padding-top: 210px">
            <h2 class="section-title">Neue Videos</h2>
            
            <!-- This is where videos will be dynamically inserted via JavaScript -->
            <div id="video-container" class="video-list">
                <!-- Template video item - this will be cloned by JavaScript -->
                <div class="video-item template" style="display: none;">
                    <div class="video-info">
                        <p class="video-date">14.04.2025</p>
                        <p class="video-category">Allgemeine Rahmenbedingungen / Gewerbe</p>
                        <h3 class="video-title">Kumulierungsmöglichkeiten verschiedener Beihilfen</h3>
                    </div>
                    <div class="video-image">
                        <img src="https://dz-bank.s3.eu-central-1.amazonaws.com/1628515448862Bild_FK-Gesch%C3%A4ft_chancen.finder.jpg" alt="Video thumbnail">
                        <div class="video-overlay">
                            Kumulierungsmöglichkeiten verschiedener Beihilfen
                        </div>
                    </div>
                </div>
                
                <!-- Example items (these would be generated by JavaScript) -->
                <div class="video-item">
                    <div class="video-info">
                        <p class="video-date">14.04.2025</p>
                        <p class="video-category">Allgemeine Rahmenbedingungen / Gewerbe</p>
                        <h3 class="video-title">Kumulierungsmöglichkeiten verschiedener Beihilfen</h3>
                    </div>
                    <div class="video-image">
                        <img src="https://dz-bank.s3.eu-central-1.amazonaws.com/1628515448862Bild_FK-Gesch%C3%A4ft_chancen.finder.jpg" alt="Video thumbnail">
                        <div class="video-overlay">
                            Kumulierungsmöglichkeiten verschiedener Beihilfen
                        </div>
                    </div>
                </div>
                
                <div class="video-item">
                    <div class="video-info">
                        <p class="video-date">14.04.2025</p>
                        <p class="video-category">Landesförderinstitute - Bayern / Gewerbe</p>
                        <h3 class="video-title">L-Bank Innovationsfinanzierung 4.0 - Neuer Programmteil KI</h3>
                    </div>
                    <div class="video-image">
                        <img src="https://dz-bank.s3.eu-central-1.amazonaws.com/1628515448862Bild_FK-Gesch%C3%A4ft_chancen.finder.jpg" alt="Video thumbnail">
                        <div class="video-overlay">
                            Kumulierungsmöglichkeiten verschiedener Beihilfen
                        </div>
                    </div>
                </div>
                
                <div class="video-item">
                    <div class="video-info">
                        <p class="video-date">14.04.2025</p>
                        <p class="video-category">Allgemeine Rahmenbedingungen / Gewerbe</p>
                        <h3 class="video-title">Kumulierungsmöglichkeiten verschiedener Beihilfen</h3>
                    </div>
                    <div class="video-image">
                        <img src="https://dz-bank.s3.eu-central-1.amazonaws.com/1628515448862Bild_FK-Gesch%C3%A4ft_chancen.finder.jpg" alt="Video thumbnail">
                        <div class="video-overlay">
                            Kumulierungsmöglichkeiten verschiedener Beihilfen
                        </div>
                    </div>
                </div>
            </div>
            
            <a href="/new_videos" class="more-link">Mehr ...</a>
        </div>
    </div>
    <script>
        // Function to fetch JSON data from a URL
        async function fetchJsonData(url) {
        try {
            const response = await fetch(url);
            
            // Check if the response is successful
            if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
            }
            
            // Parse the JSON data
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching JSON data:', error);
            return { newPublications: [], previousPublications: [] };
        }
        }

        // Function to extract videos from the JSON structure
        function extractVideos(data, maxVideos = 4) {
        const videos = [];
        
        // First, process new publications
        if (data.newPublications && data.newPublications.length > 0) {
            data.newPublications.forEach(publication => {
            if (publication.videos && publication.videos.length > 0) {
                publication.videos.forEach(video => {
                if (videos.length < maxVideos) {
                    videos.push({
                    date: "New", // Marking as new
                    category: publication.courseName,
                    title: video.videoTitle,
                    image: video.thumbnailSrc,
                    link: video.courseVideoLink,
                    overlay: video.videoTitle // Using title as overlay if not specified
                    });
                }
                });
            }
            });
        }
        
        // Then, process previous publications to fill remaining slots
        if (videos.length < maxVideos && data.previousPublications && data.previousPublications.length > 0) {
            // Sort previous publications by date (newest first)
            const sortedPrevious = [...data.previousPublications].sort((a, b) => {
            // Simple string comparison should work for "Month Year" format
            return b.date.localeCompare(a.date);
            });
            
            for (const publication of sortedPrevious) {
            if (publication.courses && publication.courses.length > 0) {
                for (const course of publication.courses) {
                if (course.videos && course.videos.length > 0) {
                    for (const video of course.videos) {
                    if (videos.length < maxVideos) {
                        videos.push({
                        date: publication.date,
                        category: course.courseName,
                        title: video.videoTitle,
                        image: video.thumbnailSrc,
                        link: video.courseVideoLink,
                        overlay: video.videoTitle // Using title as overlay if not specified
                        });
                    }
                    
                    // Break out of all loops if we've reached max videos
                    if (videos.length >= maxVideos) break;
                    }
                }
                if (videos.length >= maxVideos) break;
                }
            }
            if (videos.length >= maxVideos) break;
            }
        }
        
        return videos;
        }

        // Function to populate videos using the processed data
        function populateVideos(videoItems) {
        const container = document.getElementById('video-container');
        const template = document.querySelector('.video-item.template');
        
        // Clear existing content (except the template)
        const children = Array.from(container.children);
        children.forEach(child => {
            if (child !== template) {
            container.removeChild(child);
            }
        });
        
        // Create and append video items
        videoItems.forEach(item => {
            // Clone template
            const videoItem = template.cloneNode(true);
            videoItem.classList.remove('template');
            videoItem.style.display = '';
            
            // Set content
            videoItem.querySelector('.video-date').textContent = item.date;
            videoItem.querySelector('.video-category').textContent = item.category;
            videoItem.querySelector('.video-title').textContent = item.title;
            
            const imgElement = videoItem.querySelector('.video-image img');
            if (imgElement) {
            imgElement.src = item.image;
            imgElement.alt = item.title;
            }
            
            const overlayElement = videoItem.querySelector('.video-overlay');
            if (overlayElement) {
            overlayElement.textContent = item.overlay;
            }
            
            // Add click handler if link is provided
            if (item.link) {
            videoItem.style.cursor = 'pointer';
            videoItem.addEventListener('click', () => {
                window.location.href = item.link;
            });
            }
            
            // Append to container
            container.appendChild(videoItem);
        });
        }

        // Usage example - replace with your actual JSON file URL
        const jsonUrl = 'https://dz-bank.s3.eu-central-1.amazonaws.com/videoPublications.json';

        // Fetch and process the data
        fetchJsonData(jsonUrl).then(data => {
            const videoItems = extractVideos(data, 4); // Extract up to 4 videos
            populateVideos(videoItems);
        });
    </script>
</main>
