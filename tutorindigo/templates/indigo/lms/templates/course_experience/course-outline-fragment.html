## mako

<%page expression_filter="h"/>

<%namespace name='static' file='../static_content.html'/>

<%!
import json
import pytz

from django.utils import timezone
from django.utils.translation import gettext as _
from django.utils.translation import ngettext

from lms.djangoapps.courseware.access import has_access
from openedx.core.djangolib.markup import HTML, Text
%>

<%
course_sections = blocks.get('children')
is_course_staff = bool(user and course and has_access(user, 'staff', course, course.id))
%>
<main role="main" class="course-outline" id="main" tabindex="-1">
    % if course_sections is not None:
        <button class="btn btn-outline-primary pull-right"
                id="expand-collapse-outline-all-button"
                aria-expanded="false"
                aria-controls="course-outline-block-tree"
                >
          <span class="expand-collapse-outline-all-extra-padding" id="expand-collapse-outline-all-span">${_("Expand All")}</span>
        </button>
        <ol class="block-tree accordion"
            id="course-outline-block-tree"
            aria-labelledby="expand-collapse-outline-all-button">
        % for section in course_sections:
            <%
            section_is_auto_opened = section.get('resume_block') is True
            scored = 'scored' if section.get('scored', False) else ''
            %>
                <li class="outline-item section ${scored}" style="display: contents; height: 100%;">
                    <button class="section-name accordion-trigger outline-button" style="margin-top: 20px;"
                            aria-expanded="${ 'true' if section_is_auto_opened else 'false' }"
                            aria-controls="${ section['id'] }_contents"
                            id="${ section['id'] }">
                        <span class="fa fa-plus ${ 'fa-minus' if section_is_auto_opened else '' }" aria-hidden="true"></span>
                        <h3 class="section-title">${ section['display_name'] }</h3>
            % if section.get('complete'):
                            <span class="complete-checkmark fa fa-check" aria-hidden="true"></span>
                            <span class="sr">${_("Completed")}</span>
            % endif
                    </button>
                    <ol class="outline-item accordion-panel ${ '' if section_is_auto_opened else 'is-hidden' }"
                        id="${ section['id'] }_contents"
                        aria-labelledby="${ section['id'] }">
            % for subsection in section.get('children', []):
                <%
                gated_subsection = subsection['id'] in gated_content
                needs_prereqs = not gated_content[subsection['id']]['completed_prereqs'] if gated_subsection else False
                scored = 'scored' if subsection.get('scored', False) else ''
                graded = 'graded' if subsection.get('graded') else ''
                num_graded_problems = subsection.get('num_graded_problems', 0)
                %>
                        <li class="subsection accordion ${ 'current' if subsection.get('resume_block') else '' } ${graded} ${scored}">
                            <a
                            % if enable_links:
                                href="${ subsection['lms_web_url'] }"
                            % else:
                                aria-disabled="true"
                            % endif
                                class="subsection-text outline-button"
                                id="${ subsection['id'] }"
                            >
                            % if graded and scored and 'special_exam_info' not in subsection:
                                      <span class="icon fa fa-pencil-square-o" aria-hidden="true"></span>
                            % endif
                                      <h4 class="subsection-title">
                                          ${ subsection['display_name'] }
                            % if num_graded_problems:
                                          ${ngettext("({number} Question)",
                                                     "({number} Questions)",
                                                     num_graded_problems).format(number=num_graded_problems)}
                            % endif
                                      </h4>
                            % if subsection.get('complete'):
                                <span class="complete-checkmark fa fa-check" aria-hidden="true"></span>
                                <span class="sr">${_("Completed")}</span>
                            % endif
                            % if needs_prereqs:
                                    <div class="details prerequisite">
                                        <span class="prerequisites-icon icon fa fa-lock" aria-hidden="true"></span>
                                        ${ _("Prerequisite: ") }
                                            <%
                                                prerequisite_id = gated_content[subsection['id']]['prerequisite']
                                                prerequisite_name = xblock_display_names.get(prerequisite_id)
                                            %>
                                            ${ prerequisite_name }
                                    </div>
                            % endif
                                        <div class="details">
            
                                        </div>
                            </a>
                        </li>
            % endfor
                    
                    <div class="iframe-container"></div>
                    </ol>
                </li>
        % endfor
        </ol>
    % endif
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
          const courseLinks = document.querySelectorAll("li.subsection a");
        
          // --- Helper: extract block ID from URL ---
          function extractBlockId(url) {
            const match = url.match(/block@([^/?#]+)/);
            return match ? match[1] : null;
          }
        
          // --- Helper: close all iframes ---
          function closeAllIframes() {
            document.querySelectorAll('.iframe-container').forEach(container => container.remove());
          }
        
          // --- Helper: open a video link in an iframe ---
          function openVideo(targetUrl, linkElement) {
            // Close all existing iframes before opening a new one
            closeAllIframes();
        
            // Create a fresh iframe container
            let iframeContainer = linkElement.parentElement.parentElement.querySelector('.iframe-container');
            if (!iframeContainer) {
              iframeContainer = document.createElement("div");
              iframeContainer.className = "iframe-container";
              linkElement.parentElement.parentElement.appendChild(iframeContainer);
            }
        
            // Create and configure iframe
            const iframe = document.createElement("iframe");
            iframe.sandbox = "allow-same-origin allow-scripts allow-forms";
            iframe.style.width = "100%";
            iframe.style.height = "800px";
            iframe.style.border = "1px solid #ccc";
            iframe.setAttribute("allowfullscreen", "true");
            iframe.src = targetUrl;
        
            iframeContainer.appendChild(iframe);
            iframe.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        
          // --- Normal click handling ---
          courseLinks.forEach(link => {
            link.addEventListener("click", function (event) {
              event.preventDefault();
              const targetUrl = this.getAttribute("href");
              openVideo(targetUrl, this);
            });
          });
        
          // --- Auto-load logic ---
          const params = new URLSearchParams(window.location.search);
          const autoVideoId = params.get('video'); // e.g. ?video=35adca637a06489e920dc6ea12720e59
        
          if (autoVideoId) {
            const matchingLink = Array.from(courseLinks).find(link => {
              const linkBlockId = extractBlockId(link.href);
              return linkBlockId === autoVideoId;
            });
        
            if (matchingLink) {
              //Close all open sections first
              document.querySelectorAll("button.section-name.accordion-trigger.outline-button.is-open")
                .forEach(btn => btn.click());
        
              //Open the section that contains our video
              const section = matchingLink.closest("li.outline-item.section");
              const sectionButton = section ? section.querySelector(":scope > button.section-name.accordion-trigger.outline-button") : null;
              if (sectionButton && !sectionButton.classList.contains("is-open")) {
                sectionButton.click();
              }
        
              //Wait a bit for the section to open, then load and scroll
              setTimeout(() => {
                const targetUrl = matchingLink.getAttribute("href");
                openVideo(targetUrl, matchingLink);
              }, 500);
            } else {
              console.warn("No matching video link found for ID:", autoVideoId);
            }
          }
        });
    </script>
    <script>
        // Get the course name from the blocker-text element
        const courseName = document.querySelector('.blocker-text')?.textContent.trim().replace(' ', '+') || document.querySelector('.page-title')?.textContent.trim().replace(' ', '+');
        
        if (courseName) {
          console.log('Course detected: ' + courseName);
          // Base S3 URL
          const baseUrl = 'https://dz-bank.s3.eu-central-1.amazonaws.com/';
          
          // Find all subsection elements with IDs
          const subsections = document.querySelectorAll('li.subsection a.outline-button[id]');
          
          subsections.forEach(subsection => {
            // Get the subsection title (h4 text)
            const titleElement = subsection.querySelector('h4.subsection-title');
            if (!titleElement) return;
            
            const title = titleElement.textContent.trim();
            
            // Skip if image already exists
            if (subsection.querySelector('img')) {
              console.log('Image already exists for: ' + title);
              return;
            }
            
            // Construct the image filename from the title
            // Remove special characters and replace spaces with +
            const filename = title
              .replace(/\s+/g, '+')           // Replace spaces with +
              .replace(/[()]/g, '')           // Remove parentheses
              .replace(/\./g, '')             // Remove dots
              .replace(/\//g, '')             // Remove slash
              .replace(/!/g, '')              // Remove exclamation marks
              .replace(/\?/g, '');            // Remove question marks
            
            // Construct full S3 URL
            const imageUrl = baseUrl + encodeURIComponent(courseName).replace(/%2B/g, '+') + '/Thumbnails/' + filename + '.webp';
            
            console.log('Attempting to load: ' + title + ' -> ' + imageUrl);
            
            // Create and test the image
            const testImg = new Image();
            testImg.onload = function() {
              // Image exists, add it to the page
              const imgNode = document.createElement('img');
              imgNode.style = 'width: 100%;';
              imgNode.src = imageUrl;
              subsection.insertBefore(imgNode, subsection.firstChild);
              
              // Add play button
              const playButton = document.createElement('span');
              playButton.classList = 'btn-play fa fa-youtube-play fa-2x';
              playButton.style = 'position: absolute; left: 50%; top: 45%; transform: translate(-50%, -50%); opacity: 0.6;';
              playButton.setAttribute('aria-hidden', 'true');
              subsection.style = 'position: relative;';
              subsection.insertBefore(playButton, imgNode);
              
              console.log('✓ Successfully added image for: ' + title);
            };
            
            testImg.onerror = function() {
              console.warn('✗ Image not found: ' + imageUrl);
            };
            
            testImg.src = imageUrl;
          });
        } else {
          console.error('Course name not found in .blocker-text element');
        }
    </script>
</main>

<%static:webpack entry="CourseOutline">
    new CourseOutline();
</%static:webpack>
